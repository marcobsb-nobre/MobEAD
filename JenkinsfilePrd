pipeline {  
    environment {
      tagName = "marcos_nobre_unyleya"
      containerName = "aplicacao_ead"
    }
    agent any 
    stages { 
       stage('SonarQube analysis') {
            steps{
                script{
                    def scannerHome = tool 'sonarscan';
                    withSonarQubeEnv('sonarqube') {
                        sh "${tool("sonarscan")}/bin/sonar-scanner \
                            -Dsonar.projectKey=marcos_nobre_unyleya \
                            -Dsonar.projectName=marcos_nobre_unyleya"
                    }
                }
            }
        }
        stage('Build image') {
            steps{
                script {
                    dockerImage = docker.build ${env.tagName} + ":$BUILD_NUMBER"
                }
            }
        }
        stage('Require approval') {
           input{
                message "Do you want to proceed for production deployment?"
           }
           steps {
                sh 'echo "Deploy into Prod"'

           }
        }
        stage('Deploy container') {
            steps {
                script {
                    def fullContainerName = "${env.containerName}_${params.environment}"
                    command = """
                        docker stop ${fullContainerName} || true && \
                        docker rm ${fullContainerName} || true && \
                        docker run -d --name ${fullContainerName} \
                                -p ${params.port}:80 \
                                ${env.tagName}:$BUILD_NUMBER

                    """
                    sh command
                }
            }
        }
    } 
}